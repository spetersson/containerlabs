# {{ ansible_managed }}
frr defaults datacenter
hostname {{ frr_hostname }}
{% if frr_log_syslog %}
log syslog
{% endif %}
{% if frr_zebra_nexthop_kernel_enable %}
no zebra nexthop kernel enable
{% endif %}
debug bgp neighbor-events
debug bgp keepalives
debug bgp bfd
debug bgp aggregate
service integrated-vtysh-config
!
{% if frr_system_loopback_ipv4 and frr_system_loopback_ipv6 is defined %}
interface lo
  ip address {{ frr_system_loopback_ipv4 }}
  ipv6 address {{ frr_system_loopback_ipv6 }}
{% endif %}
exit
!
router bgp {{ frr_system_asn }}
  bgp router-id {{ frr_system_loopback_ipv4 | ansible.utils.ipaddr('address') }}
  no bgp default ipv4-unicast
  bgp bestpath as-path multipath-relax
  neighbor fabric peer-group
  neighbor fabric remote-as external
  neighbor fabric bfd
  neighbor fabric bfd profile fast
  neighbor fabric capability extended-nexthop
  neighbor fabric capability link-local
  neighbor fabric timers 0 0
  neighbor fabric timers connect 1
{% for interface in frr_system_uplinks %}
  neighbor {{ interface }} interface peer-group fabric
{% endfor %}
  !
  address-family ipv4 unicast
    redistribute kernel route-map TAG-KERNEL
    redistribute connected route-map TAG-CONNECTED
    neighbor fabric activate
    neighbor fabric next-hop-self force
    neighbor fabric route-map BGP-IMPORT in
    neighbor fabric route-map BGP-EXPORT out
  exit-address-family
  !
  address-family ipv6 unicast
    redistribute kernel route-map TAG-KERNEL
    redistribute connected route-map TAG-CONNECTED
    neighbor fabric activate
    neighbor fabric next-hop-self force
    neighbor fabric route-map BGP-IMPORT in
    neighbor fabric route-map BGP-EXPORT out
  exit-address-family
!  
route-map BGP-IMPORT permit 10
exit
!
route-map BGP-EXPORT permit 10
 match interface lo
exit
!
route-map BGP-EXPORT permit 20
 match source-protocol kernel
exit
!
route-map TAG-CONNECTED permit 10
 match source-protocol connected
 set tag 120
exit
route-map TAG-CONNECTED permit 20
 match source-protocol connected
exit
!
route-map TAG-KERNEL permit 10
 match source-protocol kernel
 set tag 110
exit
route-map TAG-KERNEL permit 20
 match source-protocol kernel
exit
!
bfd
 profile fast
 exit
 !
exit
!
